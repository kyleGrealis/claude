---
name: r-package-conventions
description: R package development conventions following usethis workflow, roxygen2 documentation standards, and CRAN requirements. Use when creating or maintaining R packages.
---

# R Package Development Conventions

This skill defines the standards and best practices for R package development, combining usethis workflows with modern package development practices.

## Package Structure

Standard R package directory structure:

```
packagename/
├── DESCRIPTION          # Package metadata
├── NAMESPACE           # Exported functions (auto-generated by roxygen2)
├── LICENSE             # License file
├── NEWS.md             # Changelog
├── README.md           # Package overview
├── R/                  # R source code
│   ├── packagename-package.R  # Package documentation
│   ├── function1.R     # One function per file (preferred)
│   └── utils.R         # Helper functions
├── man/                # Documentation (auto-generated by roxygen2)
│   ├── function1.Rd
│   └── packagename-package.Rd
├── tests/
│   ├── testthat.R      # Test runner
│   └── testthat/       # Test files
│       ├── test-function1.R
│       └── setup.R     # Test setup
├── vignettes/          # Long-form documentation
│   └── intro.Rmd
├── data/               # Exported data (optional)
│   └── dataset.rda
└── data-raw/           # Scripts to create data (optional)
    └── create_dataset.R
```

## usethis Workflow

Follow the usethis approach for package setup and maintenance:

**Initial setup**:
```r
usethis::create_package('packagename')
usethis::use_git()
usethis::use_mit_license()  # or appropriate license
usethis::use_readme_rmd()
usethis::use_news_md()
usethis::use_testthat()
usethis::use_package_doc()
```

**Adding functionality**:
```r
usethis::use_r('function_name')  # Create R file
usethis::use_test('function_name')  # Create test file
usethis::use_vignette('topic')  # Create vignette
```

**Dependencies**:
```r
usethis::use_package('dplyr')  # Add to Imports
usethis::use_pipe()  # Add pipe to package
```

## DESCRIPTION File

Complete, well-formatted DESCRIPTION file:

```
Package: packagename
Type: Package
Title: Brief Description of What the Package Does (Title Case)
Version: 0.1.0
Authors@R: 
    person("First", "Last", 
           email = "first.last@example.com", 
           role = c("aut", "cre"),
           comment = c(ORCID = "0000-0000-0000-0000"))
Description: More detailed description of what the package does. 
    This should be one paragraph and can span multiple lines.
License: MIT + file LICENSE
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.3.2
Imports:
    dplyr (>= 1.1.0),
    rlang (>= 1.1.0)
Suggests:
    testthat (>= 3.0.0),
    knitr,
    rmarkdown
VignetteBuilder: knitr
URL: https://github.com/username/packagename, https://username.github.io/packagename/
BugReports: https://github.com/username/packagename/issues
```

**Key fields**:
- `Title`: Title case, < 65 chars, no period at end
- `Description`: Complete sentences with periods
- `Authors@R`: Use `person()` with ORCID if available
- `Imports`: Runtime dependencies
- `Suggests`: Optional dependencies (tests, vignettes)
- `URL` and `BugReports`: GitHub links

## roxygen2 Documentation

Every exported function must have complete roxygen2 documentation.

**Minimal documentation block**:
```r
#' Calculate Summary Statistics
#'
#' Computes mean, median, and standard deviation for a numeric vector.
#' Missing values are handled according to the `na.rm` parameter.
#'
#' @param x A numeric vector to summarize.
#' @param na.rm Logical. Should missing values be removed? Default is `TRUE`.
#'
#' @return A named numeric vector with elements `mean`, `median`, and `sd`.
#'
#' @examples
#' x <- c(1, 2, 3, 4, 5)
#' summary_stats(x)
#'
#' # With missing values
#' x_na <- c(1, 2, NA, 4, 5)
#' summary_stats(x_na, na.rm = TRUE)
#'
#' @export
summary_stats <- function(x, na.rm = TRUE) {
  # function body
}
```

**Required tags for exported functions**:
- `@param` - One for each parameter with description and type
- `@return` - What the function returns (type and structure)
- `@examples` - Working examples that run without errors
- `@export` - Mark function as exported

**Optional but recommended tags**:
- `@family` - Group related functions
- `@seealso` - Link to related functions using `\code{\link{function}}`
- `@details` - Extended description if needed
- `@section` - Custom sections for complex documentation

**Internal functions** (not exported):
- Still document with roxygen2
- Omit `@export` tag
- Use `@keywords internal` if desired

## NAMESPACE Management

**NEVER edit NAMESPACE manually** when using roxygen2.

- NAMESPACE is auto-generated from roxygen2 tags
- Use `@export` to export functions
- Use `@importFrom pkg function` to import specific functions
- Use `@import pkg` sparingly (imports entire package namespace)
- Prefer explicit `package::function()` calls over `@import`

```r
#' @importFrom dplyr filter select mutate
#' @importFrom rlang .data
```

## Function Design

**One function per file** (preferred):
- File name: `function_name.R`
- Contains: `function_name()` and related helpers

**Helper functions**:
- Place in `R/utils.R` or similar
- Prefix with `.` if truly internal: `.validate_input()`
- Don't export unless needed

**Error handling**:
- Use `rlang::abort()` for errors in packages
- Use `rlang::warn()` for warnings
- Provide informative error messages
- Validate inputs early

```r
validate_input <- function(x) {
  if (!is.numeric(x)) {
    rlang::abort('`x` must be numeric, not {class(x)[1]}')
  }
  if (length(x) == 0) {
    rlang::abort('`x` cannot be empty')
  }
}
```

## Testing with testthat

**File structure**:
- Test file: `tests/testthat/test-function_name.R`
- Mirrors R file: `R/function_name.R`

**Test structure**:
```r
test_that('function_name returns correct type', {
  result <- function_name(c(1, 2, 3))
  expect_type(result, 'double')
  expect_length(result, 3)
})

test_that('function_name handles NA values', {
  x <- c(1, NA, 3)
  result <- function_name(x, na.rm = TRUE)
  expect_false(anyNA(result))
})

test_that('function_name validates input', {
  expect_error(
    function_name('not numeric'),
    'must be numeric'
  )
})
```

**Coverage goals**:
- Aim for >80% code coverage
- Test exported functions thoroughly
- Test error conditions
- Test edge cases (empty input, single value, all NA, etc.)

## Vignettes

**Create with**:
```r
usethis::use_vignette('topic-name')
```

**Structure**:
```yaml
---
title: "Introduction to packagename"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to packagename}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

**Content**:
- Focus on use cases and workflows
- Show realistic examples
- Guide users through features
- Link to function documentation for details

## NEWS.md

Track all changes following this format:

```markdown
# packagename (development version)

* Placeholder for changes

# packagename 1.0.0 (2025-11-21)

## Breaking changes

* `old_function()` is deprecated. Use `new_function()` instead (#123).

## New features

* New `advanced_function()` for complex operations (#134).
* `main_function()` gains `parallel` argument (#156).

## Bug fixes

* Fixed edge case where `process_data()` failed on empty input (#142).
* Improved error messages in `validate_input()` (#151).
```

**Version format**:
- Development: `# packagename (development version)`
- Release: `# packagename 1.0.0 (2025-11-21)`

## README.md

**Use README.Rmd** (knits to README.md):
```r
usethis::use_readme_rmd()
```

**Structure**:
```markdown
# packagename

<!-- badges: start -->
[![R-CMD-check](badge-url)](check-url)
<!-- badges: end -->

## Installation

```r
# CRAN
install.packages('packagename')

# Development
pak::pak('user/packagename')
```

## Usage

```r
library(packagename)

result <- main_function(data)
```

## Features

- Feature 1  
- Feature 2  
- Feature 3  
```

## Dependencies

**Minimize dependencies**:
- Only add packages to `Imports` if truly needed
- Consider alternatives to heavy dependencies
- Use `Suggests` for optional features

**Document why**:
```r
# In package documentation
#' @importFrom rlang abort .data
#' @importFrom dplyr filter select mutate
```

## CRAN Submission

**Pre-submission checks**:
```r
devtools::check()  # Must pass with 0 errors, 0 warnings, 0 notes
spelling::spell_check_package()
urlchecker::url_check()
```

**Common CRAN requirements**:
- All examples must run in < 5 seconds
- No `\dontrun{}` unless absolutely necessary
- Valid URLs in documentation
- No hard-coded file paths
- All suggested packages used conditionally

**First submission**:
```r
usethis::use_cran_comments()  # Add cran-comments.md
devtools::submit_cran()
```

## Package Documentation

**Package-level documentation** (`R/packagename-package.R`):
```r
#' packagename: Brief Package Description
#'
#' Longer description of what the package does, its main functions,
#' and key use cases.
#'
#' @keywords internal
#' @importFrom rlang .data
"_PACKAGE"
```

## Version Numbers

Follow semantic versioning:
- `1.0.0`: Major.Minor.Patch
- Increment Major: Breaking changes
- Increment Minor: New features (backward compatible)
- Increment Patch: Bug fixes

Development versions:
- `0.0.0.9000` during development
- `1.0.0.9000` after releasing 1.0.0

## Lifecycle Badges

Mark function stability:
```r
#' @section Lifecycle:
#' This function is \lifecycle{experimental} and may change in future versions.
```

Options: `experimental`, `stable`, `deprecated`, `superseded`

## Best Practices Summary

1. **Use usethis** for package setup and management
2. **Document everything** with roxygen2
3. **Test thoroughly** with testthat (aim for >80% coverage)
4. **Minimize dependencies** - only import what you need
5. **Write clear examples** that users can copy-paste
6. **Maintain NEWS.md** - document all changes
7. **Keep README current** - it's the first impression
8. **Follow CRAN standards** even if not submitting to CRAN
9. **Use `rlang::abort()`** for errors in packages
10. **Never edit NAMESPACE manually** - let roxygen2 handle it
